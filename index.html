<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Wolfe Island Ferry</title>
        <link rel="stylesheet" href="css/jqtouch.css" title="jQTouch">
    
        <script src="lib/jquery-1.7.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="lib/jqtouch.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="lib/jqtouch-jquery.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="lib/moment.min.js" type="text/javascript" charset="utf-8"></script>
        
        <script type="text/javascript" charset="utf-8">
            var jQT = new $.jQTouch({
                addGlossToIcon: false,
                statusBar: 'black-translucent',
                preloadImages: []
            });
            
            var buildSchedules = function() {
                // note: if the schedules change and there are non-equal number of 
                // crossings, there is a loop below that needs to be updated
                var schedules = {
                    kingston:[
                         {h:06,m:15}
                        ,{h:07,m:15}
                        ,{h:08,m:30}
                        ,{h:09,m:30}
                        ,{h:10,m:30}
                        ,{h:11,m:30}
                        ,{h:12,m:30}
                        ,{h:14,m:00}
                        ,{h:15,m:00}
                        ,{h:16,m:00}
                        ,{h:17,m:00}
                        ,{h:18,m:00}
                        ,{h:19,m:00}
                        ,{h:20,m:00}
                        ,{h:21,m:00}
                        ,{h:22,m:00}
                        ,{h:23,m:20}
                        ,{h:00,m:40}
                        ,{h:02,m:00}
                    ],
                    island:[
                         {h:05,m:45}
                        ,{h:06,m:45}
                        ,{h:07,m:45}
                        ,{h:09,m:00}
                        ,{h:10,m:00}
                        ,{h:11,m:00}
                        ,{h:12,m:00}
                        ,{h:13,m:15}
                        ,{h:14,m:30}
                        ,{h:15,m:30}
                        ,{h:16,m:30}
                        ,{h:17,m:30}
                        ,{h:18,m:30}
                        ,{h:19,m:30}
                        ,{h:20,m:30}
                        ,{h:21,m:30}
                        ,{h:22,m:40}
                        ,{h:00,m:00}
                        ,{h:01,m:20}
                    ]
                };
                
                // expand out the base objects
                
                $.each(schedules.kingston, function(i) {
                    var tod = (this.h*60)+this.m; // time-of-day serves as our ID
                    schedules.kingston[i] = {
                        tod:tod,
                        h:this.h,
                        m:this.m,
                        departing:'Kingston'
                    };
                });
                $.each(schedules.island, function(i) {
                    var tod = (this.h*60)+this.m; // time-of-day serves as our ID
                    schedules.island[i] = {
                        tod:tod,
                        h:this.h,
                        m:this.m,
                        departing:'Island'
                    };
                });
                
                return schedules;
            }
            
            /** Returns an object containing the next departure times for
             * .kingston, .island, and .next. 
             * A .date property (moment object) is also added to the time objects, 
             * indicating the percise date/time of next crossing.
             */
            var findNextTimes = function() {                
                var now = new moment();
                var tod = (now.hours()*60) + now.minutes();
                var nextTime = null;
                var next = {
                    kingston: schedules.kingston[0],
                    island: schedules.island[0],
                };
                var compareTimes = function(start, compare, end) {
                    // if end > start, compare comes between start and end
                    // or, end < start (eg, from 11pm to 1am), 
                    //     compare is before start (eg, 1am)
                    //     xor compare is after end (eg, 11pm)
                    if (end < start) {
                        console.log('end<start', end, start, compare, (compare < start), (compare > end));
                    }
                    return ((end > start) && (compare >= start) && (compare < end))
                           || ((end < start) 
                               &&  ((compare < start) || (compare > end))
                               && !((compare < start) && (compare > end))); //xor
                }

                for (var i = 1; i<schedules.kingston.length; i++) {
                    if (compareTimes(schedules.kingston[i-1].tod, tod, schedules.kingston[i].tod)) {
                        next.kingston = schedules.kingston[i];
                    }
                }
                for (var i = 1; i<schedules.island.length; i++) {                    
                    if (compareTimes(schedules.island[i-1].tod, tod, schedules.island[i].tod)) {
                        next.island = schedules.island[i];
                    }
                }
                
                next.kingston.date = moment(
                    new Date(now.year(),
                             now.month(),
                             now.date() + ((next.kingston.tod < tod) ? 1 : 0),
                             next.kingston.h,
                             next.kingston.m));
                next.island.date = moment(
                    new Date(now.year(),
                             now.month(),
                             now.date() + ((next.island.tod < tod) ? 1 : 0),
                             next.island.h,
                             next.island.m));
                
                next.next = (next.kingston.date.valueOf() < next.island.date.valueOf()) ? next.kingston : next.island;
                return next;
            }
            
            var formatTime = function(time) {
                var m = ((time.m < 10) ? '0'+time.m : time.m);
                if (time.h == 0) {
                    return '12:'+m+' AM';
                } else if (time.h < 12) {
                    return time.h+':'+m+' AM';
                } else if (time.h == 12) {
                    return time.h+':'+m+' PM';
                } else {
                    return (time.h-12)+':'+m+' PM';
                }
            }
            
            var populateSchedulePage = function() {
                var titles = '<li class="sep"><div>From Island</div><div>From Kingston</div></li>';
                var html = titles;
                
                //Note: this loop needs to be modified if the crossing times are ever not equal
                if (schedules.kingston.length != schedules.island.length) {
                    alert('Times do not match! populateSchedulePage() has to be updated.');
                    return;
                };
                
                for (var i = 0; i < schedules.kingston.length; i++) {
                    html += '<li><div class="sched sched-'+schedules.island[i].tod+'">'+formatTime(schedules.island[i])+'</div>' + 
                            '<div class="sched sched-'+schedules.kingston[i].tod+'">'+formatTime(schedules.kingston[i])+'</div></li>';
                    if (i == Math.floor(schedules.kingston.length/2)-1) {
                        html += titles;
                    }
                }
                html += titles;
                
                $('#schedule ul.schedule').html(html);
            };
            
            var refreshNextTimes = function() {
                nextTimes = findNextTimes();
                $('.kingston .next-departure').html('<em>Next trip:</em> '+nextTimes.kingston.date.fromNow()+
                                                    '<small class="count">'+formatTime(nextTimes.kingston)+'</small>');
                $('.island .next-departure').html('<em>Next trip:</em> '+nextTimes.island.date.fromNow()+
                                                  '<small class="count">'+formatTime(nextTimes.island)+'</small>');
                                                  
                // highlight schedule entry
                $('.sched').removeClass('next').removeClass('next-actual');
                $('.sched.sched-'+nextTimes.island.tod).addClass('next');
                $('.sched.sched-'+nextTimes.kingston.tod).addClass('next');
                $('.sched.sched-'+nextTimes.next.tod).addClass('next-actual');
            };
            
            var refreshCameras = function() {
                var hash = new Date().getTime();
                console.log('refreshing cams', hash);
                $('.cam img').each(function() {
                    $(this).attr('src', $(this).data('src')+'?'+hash);
                });
            };
            
            var nextTimer, cameraTimer;
            var ensureRefreshRunning = function() {
                nextTimer = setInterval(refreshNextTimes, 45000);  // 45s
                cameraTimer = setInterval(refreshCameras, 120000); // 2mins (MTO only updates every 2 mins)
            };
            
            
            var schedules = buildSchedules();
            
            var nextTimes = null; // periodically refreshed with the next times
            
            
            
            $(function(){
                // Orientation callback event
                $('#jqt').bind('turn', function(e, data){
                    $('#orient').html('Orientation: ' + data.orientation);
                });
                
                populateSchedulePage();
                    
                refreshNextTimes();
                refreshCameras();
                
                ensureRefreshRunning();
                
            });
        </script>        
        <style type="text/css" media="screen">
            #jqt.fullscreen #home .info {
                display: none;
            }
            li.cam {
                text-align:center;
            }
            li.cam img {
                max-width:100%;
            }
            
            ul.schedule li div {
                width:48%;
                float:left;
                text-align:center;
            }
            ul.schedule li div.next {
                color:#93B893;
            }
            ul.schedule li div.next-actual {
                color:green;
            }
        </style>
    </head>
    <body>
        <div id="jqt">
            <div id="home" class="current">
                <div class="toolbar">
                    <h1>Wolfe Island Ferry</h1>
                </div>
                <div class="scroll">
                    <ul class="rounded">
                        <li class="arrow"><a href="#schedule">Schedule</a> </li>
                    </ul>
                    <h2>Cameras</h2>
                    <ul class="rounded">
                        <li class="arrow"><a href="#kingston">Kingston Dock</a> </li>
                        <li class="arrow"><a href="#marysville">Island - Marysville Dock (Summer)</a> </li>
                        <li class="arrow"><a href="#dawsons">Island - Dawsons Point (Winter)</a> </li>
                    </ul>
                    <div class="info">
                        <p>Add this page to your home screen.</p>
                    </div>
                </div>
            </div>
            <div id="schedule">
                <div class="toolbar">
                    <h1>Ferry Schedule</h1>
                    <a href="#" class="back">Back</a>
                </div>
                <ul class="edgetoedge scroll schedule"></ul>
            </div>
            <div id="kingston" class="kingston">
                <div class="toolbar">
                    <h1>Kingston Dock</h1>
                    <a href="#" class="back">Back</a>
                </div>
                <ul class="edgetoedge scroll">
                    <li class="next-departure"></li>
                    <li class="cam"><img data-src="http://www.mto.gov.on.ca/english/traveller/compass/camera/pictures/OttaCamera/loc56.jpg" /></li>
                </ul>
            </div>
            <div id="marysville" class="island">
                <div class="toolbar">
                    <h1>Marysville (Summer Dock)</h1>
                    <a href="#" class="back">Back</a>
                </div>
                <ul class="edgetoedge scroll">
                    <li class="next-departure"></li>
                    <li class="cam"><img data-src="http://www.mto.gov.on.ca/english/traveller/compass/camera/pictures/OttaCamera/loc57.jpg" /></li>
                    <li class="cam"><img data-src="http://www.mto.gov.on.ca/english/traveller/compass/camera/pictures/OttaCamera/loc58.jpg" /></li>
                </ul>
            </div>
            <div id="dawsons" class="island">
                <div class="toolbar">
                    <h1>Dawson's Point (Winter Dock)</h1>
                    <a href="#" class="back">Back</a>
                </div>
                <ul class="edgetoedge scroll">
                    <li class="next-departure"></li>
                    <li class="cam"><img data-src="http://www.mto.gov.on.ca/english/traveller/compass/camera/pictures/OttaCamera/loc60.jpg" /></li>
                    <li class="cam"><img data-src="http://www.mto.gov.on.ca/english/traveller/compass/camera/pictures/OttaCamera/loc59.jpg" /></li>
                </ul>
            </div>
        </div>
    </body>
</html>
